<div class="p-8 rounded-3xl shadow-2xl text-textlight border border-gray-700 font-body bg-gray-900/50 backdrop-blur-sm max-w-5xl mx-auto my-8">

  <div *ngIf="isLoading()" class="flex flex-col items-center justify-center p-16 text-center animate-pulse" 
       appSpeak="Loading Exam, please wait." tabindex="0">
    <div class="text-primary text-2xl font-bold mb-4">Loading Exam...</div>
    <div class="text-textlight/70 text-lg">Please wait while we retrieve the questions.</div>
  </div>

  <div *ngIf="errorMessage()" class="text-center p-16 border-2 border-dashed border-red-500/50 rounded-2xl bg-inputbg"
       [attr.aria-label]="errorMessage()" tabindex="0">
    <p class="text-2xl font-bold text-red-500 mb-4">Error Occurred</p>
    <p class="text-textlight/80 mb-6">{{ errorMessage() }}</p>
    <button (click)="goBack()" 
            class="bg-gray-700 text-textlight px-6 py-2 rounded-lg hover:bg-gray-600 transition shadow-lg">
      Go Back
    </button>
  </div>

  <div *ngIf="examData() && !isLoading() && !isSubmitted()" class="space-y-8">
    
    <header class="flex flex-col md:flex-row justify-between items-start md:items-center border-b border-gray-700 pb-6">
      <h2 class="text-3xl font-extrabold text-primary font-display tracking-tight mb-4 md:mb-0"
          tabindex="0" (focus)="onFocus(examData()?.title)">
        {{ examData()?.title }}
      </h2>
      
      <span class="text-sm font-bold text-primary bg-primary/10 px-4 py-2 rounded-full border border-primary/40 shadow-[0_0_10px_rgba(var(--primary),0.2)]"
            tabindex="0" (focus)="onFocus('Question ' + (currentQuestionIndex() + 1) + ' of ' + examData()?.questions?.length)">
        Question {{ currentQuestionIndex() + 1 }} / {{ examData()?.questions?.length }}
      </span>
    </header>

    <div class="bg-inputbg p-8 rounded-2xl shadow-lg border border-gray-700 relative">
      
      <div class="mb-8 group outline-none">
        <h3 tabindex="0"
            (focus)="speakCurrentQuestion()"
            (click)="speakCurrentQuestion()"
            class="text-2xl md:text-3xl font-bold text-textlight cursor-pointer hover:text-primary transition duration-300 flex items-start gap-3 outline-none focus:text-primary focus:underline decoration-dashed decoration-primary/50"
            title="Click or Tab to hear the question">
          <span>{{ currentQuestion()?.question }}</span>
          <span class="text-lg opacity-50 group-hover:opacity-100 transition-opacity">ðŸ”Š</span>
        </h3>
      </div>

      <ul class="space-y-4">
        <li *ngFor="let ans of currentQuestion()?.answers; let i = index"
            tabindex="0"
            (focus)="onFocus('Option ' + (i + 1) + '. ' + ans)" 
            (click)="selectAnswer(i)"
            (keydown.enter)="handleAnswerEnter(i)"
            class="group flex items-center p-4 rounded-xl border-2 cursor-pointer transition-all duration-300 transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-primary/50"
            [ngClass]="{
              'border-primary bg-primary/10 shadow-md shadow-primary/10': i === currentSelectedAnswerIndex(),
              'border-gray-700 bg-gray-800/50 hover:border-gray-500': i !== currentSelectedAnswerIndex()
            }">
            
            <span class="w-8 h-8 flex items-center justify-center rounded-full font-bold mr-4 transition-colors"
                  [ngClass]="{
                    'bg-primary text-background': i === currentSelectedAnswerIndex(),
                    'bg-gray-700 text-textlight/70 group-hover:bg-gray-600': i !== currentSelectedAnswerIndex()
                  }">
              {{ i + 1 }}
            </span>

            <span class="flex-grow text-lg font-medium"
                  [ngClass]="{
                    'text-primary': i === currentSelectedAnswerIndex(),
                    'text-textlight/90': i !== currentSelectedAnswerIndex()
                  }">
              {{ ans }}
            </span>

            <span *ngIf="i === currentSelectedAnswerIndex()" class="text-primary text-xl font-bold animate-bounce">
              âœ”
            </span>
        </li>
      </ul>
    </div>

    <footer class="flex flex-wrap justify-between items-center gap-4 pt-4">
      
      <button (click)="prevQuestion()" 
              (focus)="onFocus('Previous Question Button')"
              [disabled]="currentQuestionIndex() === 0"
              [class.opacity-50]="currentQuestionIndex() === 0"
              [class.cursor-not-allowed]="currentQuestionIndex() === 0"
              class="flex items-center space-x-2 bg-gray-700 text-textlight px-6 py-3 rounded-xl font-medium hover:bg-gray-600 transition shadow-lg focus:outline-none focus:ring-4 focus:ring-gray-500">
        <span>â¬… Previous</span>
      </button>

      <button (click)="goBack()" 
              (focus)="onFocus('Exit Exam Button')"
              class="text-textlight/60 hover:text-red-400 font-medium px-4 py-2 transition-colors focus:outline-none focus:text-red-400 focus:underline">
        Exit Exam
      </button>

      <button *ngIf="currentQuestionIndex() < (examData()?.questions?.length || 0) - 1" 
              (click)="nextQuestion()" 
              (focus)="onFocus('Next Question Button')"
              class="flex items-center space-x-2 bg-primary text-background px-8 py-3 rounded-xl font-bold hover:bg-primary/90 transition shadow-lg shadow-primary/30 transform hover:-translate-y-1 focus:outline-none focus:ring-4 focus:ring-primary">
        <span>Next âž¡</span>
      </button>

      <button *ngIf="currentQuestionIndex() === (examData()?.questions?.length || 0) - 1" 
              (click)="submitExam()" 
              (focus)="onFocus('Finish Exam Button')"
              class="flex items-center space-x-2 bg-green-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-green-500 transition shadow-lg shadow-green-600/30 transform hover:-translate-y-1 focus:outline-none focus:ring-4 focus:ring-green-500">
        <span>Finish Exam âœ…</span>
      </button>

    </footer>
  </div>

  <div *ngIf="isSubmitted()" class="flex flex-col items-center justify-center py-12 animate-fade-in-up" tabindex="0" (focus)="onFocus('Exam Completed. Your score is displayed below.')">
    
    <div class="bg-inputbg p-10 rounded-3xl shadow-2xl border border-gray-700 text-center max-w-lg w-full">
      <h2 class="text-3xl font-extrabold text-textlight mb-8 font-display">Exam Completed! ðŸŽ‰</h2>
      
      <div class="relative w-48 h-48 mx-auto mb-8 flex items-center justify-center rounded-full border-8 border-gray-700 bg-gray-800 shadow-inner">
        <div class="text-center z-10">
          <div class="text-5xl font-extrabold text-primary">{{ scorePercentage() }}%</div>
          <div class="text-sm text-textlight/60 uppercase tracking-widest mt-1">Score</div>
        </div>
        <div class="absolute inset-0 rounded-full border-8 border-primary opacity-20"></div>
      </div>

      <p class="text-xl text-textlight/80 mb-8" tabindex="0" (focus)="onFocus('You got ' + totalCorrect() + ' correct answers.')">
        You got <strong class="text-primary text-2xl">{{ totalCorrect() }}</strong> out of 
        <strong class="text-textlight">{{ examData()?.questions?.length }}</strong> correct.
      </p>

      <button (click)="goBack()" 
              (focus)="onFocus('Close and Return to Class Button')"
              class="w-full bg-primary text-background py-4 rounded-xl font-bold text-lg hover:bg-primary/90 transition shadow-lg shadow-primary/30 focus:outline-none focus:ring-4 focus:ring-primary">
        Close & Return to Class
      </button>
    </div>

  </div>

</div>